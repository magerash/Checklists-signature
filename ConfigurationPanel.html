<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      padding: 20px;
      background-color: #f5f5f5;
      color: #333;
      position: relative;
    }
    
    .container {
      max-width: 100%;
      position: relative;
    }
    
    h1 {
      color: #2c3e50;
      margin-bottom: 20px;
      font-size: 24px;
      border-bottom: 2px solid #3498db;
      padding-bottom: 10px;
    }
    
    .section {
      background-color: white;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: opacity 0.3s ease;
    }
    
    .section.disabled {
      opacity: 0.6;
      pointer-events: none;
    }
    
    .section-title {
      color: #3498db;
      margin-bottom: 15px;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .section-title i {
      font-size: 20px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #555;
      font-size: 14px;
    }
    
    input[type="text"],
    input[type="number"],
    input[type="color"] {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    
    input[type="text"]:focus,
    input[type="number"]:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }
    
    input:disabled {
      background-color: #f8f9fa;
      cursor: not-allowed;
    }
    
    .color-input-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .color-input-group input[type="color"] {
      width: 50px;
      height: 40px;
      padding: 2px;
      cursor: pointer;
    }
    
    .color-input-group input[type="text"] {
      flex: 1;
    }
    
    .buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    #saveBtn {
      background-color: #2ecc71;
      color: white;
    }
    
    #saveBtn:hover:not(:disabled) {
      background-color: #27ae60;
    }
    
    #resetBtn {
      background-color: #e74c3c;
      color: white;
    }
    
    #resetBtn:hover:not(:disabled) {
      background-color: #c0392b;
    }
    
    /* Modal Popup Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      backdrop-filter: blur(2px);
      animation: fadeIn 0.3s ease;
    }
    
    .modal-overlay.active {
      display: flex;
    }
    
    .modal {
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      width: 90%;
      max-width: 400px;
      overflow: hidden;
      transform: translateY(20px);
      animation: modalSlideIn 0.4s ease forwards;
    }
    
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .modal-header {
      padding: 20px 24px 10px;
      text-align: center;
    }
    
    .modal-icon {
      font-size: 48px;
      margin-bottom: 15px;
      display: block;
      text-align: center;
    }
    
    .modal-title {
      font-size: 22px;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 8px;
    }
    
    .modal-subtitle {
      font-size: 16px;
      color: #7f8c8d;
      line-height: 1.4;
    }
    
    .modal-content {
      padding: 0 24px 20px;
      text-align: center;
    }
    
    .modal-message {
      font-size: 16px;
      color: #333;
      margin-bottom: 20px;
      line-height: 1.5;
    }
    
    .modal-footer {
      padding: 20px 24px;
      background-color: #f8f9fa;
      border-top: 1px solid #e9ecef;
      display: flex;
      justify-content: center;
    }
    
    .modal-btn {
      padding: 10px 24px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      min-width: 120px;
    }
    
    .modal-btn-ok {
      background-color: #3498db;
      color: white;
    }
    
    .modal-btn-ok:hover {
      background-color: #2980b9;
    }
    
    .modal-btn-cancel {
      background-color: #95a5a6;
      color: white;
      margin-right: 10px;
    }
    
    .modal-btn-cancel:hover {
      background-color: #7f8c8d;
    }
    
    .success .modal-icon { color: #2ecc71; }
    .error .modal-icon { color: #e74c3c; }
    .info .modal-icon { color: #3498db; }
    .warning .modal-icon { color: #f39c12; }
    
    .status-message {
      margin-top: 15px;
      padding: 15px;
      border-radius: 4px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 10px;
      min-height: 50px;
    }
    
    .success-bg {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      display: flex;
    }
    
    .error-bg {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      display: flex;
    }
    
    .info-bg {
      background-color: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
      display: flex;
    }
    
    .note {
      font-size: 12px;
      color: #7f8c8d;
      margin-top: 5px;
      font-style: italic;
    }
    
    .example {
      font-size: 12px;
      color: #3498db;
      background-color: #ebf5fb;
      padding: 5px 8px;
      border-radius: 3px;
      margin-top: 5px;
      display: inline-block;
    }
    
    .column-info {
      font-size: 12px;
      color: #3498db;
      margin-left: 5px;
      font-weight: normal;
    }
    
    /* Loading spinner */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(52, 152, 219, 0.3);
      border-radius: 50%;
      border-top-color: #3498db;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Progress bar container */
    .progress-container {
      width: 100%;
      height: 4px;
      background-color: #e9ecef;
      border-radius: 2px;
      margin-top: 10px;
      overflow: hidden;
      display: none;
    }
    
    .progress-bar {
      height: 100%;
      background-color: #3498db;
      width: 0%;
      transition: width 0.4s ease;
      border-radius: 2px;
    }
    
    /* Loading overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255, 255, 255, 0.9);
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 1000;
    }
    
    .loading-overlay.active {
      display: flex;
      animation: fadeIn 0.3s ease;
    }
    
    .loading-overlay-content {
      text-align: center;
      padding: 30px;
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      max-width: 300px;
      width: 80%;
    }
    
    .loading-overlay .spinner {
      width: 40px;
      height: 40px;
      margin-bottom: 20px;
    }
    
    .loading-overlay h3 {
      margin-bottom: 10px;
      color: #2c3e50;
    }
    
    .loading-overlay p {
      color: #7f8c8d;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-overlay-content">
      <div class="spinner"></div>
      <h3 id="loadingTitle">–û–±—Ä–∞–±–æ—Ç–∫–∞...</h3>
      <p id="loadingMessage">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ</p>
      <div class="progress-container" id="progressContainer">
        <div class="progress-bar" id="progressBar"></div>
      </div>
    </div>
  </div>
  
  <!-- Modal Popup -->
  <div id="modalOverlay" class="modal-overlay">
    <div class="modal" id="messageModal">
      <div class="modal-header">
        <span class="modal-icon" id="modalIcon">‚úÖ</span>
        <h3 class="modal-title" id="modalTitle">–£—Å–ø–µ—à–Ω–æ!</h3>
        <p class="modal-subtitle" id="modalSubtitle">–û–ø–µ—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞</p>
      </div>
      <div class="modal-content">
        <p class="modal-message" id="modalMessage">–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞.</p>
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-btn-ok" id="modalOkBtn">OK</button>
      </div>
    </div>
  </div>
  
  <!-- Confirmation Modal -->
  <div id="confirmModalOverlay" class="modal-overlay">
    <div class="modal" id="confirmModal">
      <div class="modal-header">
        <span class="modal-icon">‚ö†Ô∏è</span>
        <h3 class="modal-title" id="confirmModalTitle">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h3>
        <p class="modal-subtitle" id="confirmModalSubtitle">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</p>
      </div>
      <div class="modal-content">
        <p class="modal-message" id="confirmModalMessage">–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-btn-cancel" id="confirmCancelBtn">–û—Ç–º–µ–Ω–∞</button>
        <button class="modal-btn modal-btn-ok" id="confirmOkBtn">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
      </div>
    </div>
  </div>
  
  <div class="container">
    <h1>‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –ø–æ–¥–ø–∏—Å–∏</h1>
    
    <div id="formSections">
      <div class="section" id="basicSection">
        <div class="section-title">
          üìã –û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
        </div>
        
        <div class="form-group">
          <label for="SHEET_NAME">–ò–º—è —Ä–∞–±–æ—á–µ–≥–æ –ª–∏—Å—Ç–∞:</label>
          <input type="text" id="SHEET_NAME" name="SHEET_NAME" placeholder="II. –ß–µ–∫-–ª–∏—Å—Ç —Å—Ç–∞–¥–∏–∏ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏">
          <div class="note">–õ–∏—Å—Ç, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Ç–∞–±–ª–∏—Ü–∞ —Å –ø–æ–¥–ø–∏—Å—è–º–∏</div>
        </div>
        
        <div class="form-group">
          <label for="DATA_RANGE_NAME">–ò–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞–Ω–Ω—ã—Ö:</label>
          <input type="text" id="DATA_RANGE_NAME" name="DATA_RANGE_NAME" placeholder="dt_sign_allData">
          <div class="note">–ò–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö –∏ –ø–æ–¥–ø–∏—Å—è—Ö</div>
        </div>
      </div>
      
      <div class="section" id="columnsSection">
        <div class="section-title">
          üìä –°—Ç–æ–ª–±—Ü—ã (–º–æ–∂–Ω–æ —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é –∏–ª–∏ –¥–∏–∞–ø–∞–∑–æ–Ω—ã)
        </div>
        
        <div class="form-group">
          <label for="CHECKBOX_COLUMNS">
            –°—Ç–æ–ª–±—Ü—ã —Å —á–µ–∫–±–æ–∫—Å–∞–º–∏ <span class="column-info">(–Ω–æ–º–µ—Ä–∞: A=1, B=2, ...)</span>:
          </label>
          <input type="text" id="CHECKBOX_COLUMNS" name="CHECKBOX_COLUMNS" placeholder="12,22">
          <div class="note">–°—Ç–æ–ª–±—Ü—ã, –≤ –∫–æ—Ç–æ—Ä—ã—Ö –Ω–∞—Ö–æ–¥—è—Ç—Å—è —á–µ–∫–±–æ–∫—Å—ã –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø–æ–¥–ø–∏—Å–∏</div>
          <div class="example">–ü—Ä–∏–º–µ—Ä—ã: "12", "12,22", "12-15", "12,22,25-28"</div>
        </div>
        
        <div class="form-group">
          <label for="STATUS_COLUMNS">
            –°—Ç–æ–ª–±—Ü—ã —Å–æ —Å—Ç–∞—Ç—É—Å–∞–º–∏ <span class="column-info">(–Ω–æ–º–µ—Ä–∞: A=1, B=2, ...)</span>:
          </label>
          <input type="text" id="STATUS_COLUMNS" name="STATUS_COLUMNS" placeholder="11,21">
          <div class="note">–°—Ç–æ–ª–±—Ü—ã, –≤ –∫–æ—Ç–æ—Ä—ã—Ö –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∏</div>
          <div class="example">–ü—Ä–∏–º–µ—Ä—ã: "11", "11,21", "11-13", "11,21,24-26"</div>
        </div>
        
        <div class="form-group">
          <label for="NAME_COLUMNS">
            –°—Ç–æ–ª–±—Ü—ã —Å –∏–º–µ–Ω–∞–º–∏ <span class="column-info">(–Ω–æ–º–µ—Ä–∞: A=1, B=2, ...)</span>:
          </label>
          <input type="text" id="NAME_COLUMNS" name="NAME_COLUMNS" placeholder="10,20">
          <div class="note">–°—Ç–æ–ª–±—Ü—ã, –≤ –∫–æ—Ç–æ—Ä—ã—Ö –Ω–∞—Ö–æ–¥—è—Ç—Å—è –∏–º–µ–Ω–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤</div>
          <div class="example">–ü—Ä–∏–º–µ—Ä—ã: "10,20", "10-12", "10,12,15" (–æ–±—ã—á–Ω–æ —ç—Ç–æ —á–µ–∫–±–æ–∫—Å - 2)</div>
        </div>
      </div>
      
      <div class="section" id="rowsSection">
        <div class="section-title">
          üìà –î–∏–∞–ø–∞–∑–æ–Ω—ã —Å—Ç—Ä–æ–∫ (–º–æ–∂–Ω–æ —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é –∏–ª–∏ –¥–∏–∞–ø–∞–∑–æ–Ω—ã)
        </div>
        
        <div class="form-group">
          <label for="ROW_RANGES">–î–∏–∞–ø–∞–∑–æ–Ω—ã —Å—Ç—Ä–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏:</label>
          <input type="text" id="ROW_RANGES" name="ROW_RANGES" placeholder="5-13">
          <div class="note">–°—Ç—Ä–æ–∫–∏, –≤ –∫–æ—Ç–æ—Ä—ã—Ö –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ–∫–±–æ–∫—Å–∞</div>
          <div class="example">–ü—Ä–∏–º–µ—Ä—ã: "5-13", "5-10,15-20", "5,6,7,10-15", "5-10,15-20,25-30"</div>
        </div>
      </div>
      
      <div class="section" id="textSection">
        <div class="section-title">
          ‚úèÔ∏è –¢–µ–∫—Å—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        </div>
        
        <div class="form-group">
          <label for="DEFAULT_STATUS_TEXT">–¢–µ–∫—Å—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ —Å—Ç–æ–ª–±—Ü–µ —Å—Ç–∞—Ç—É—Å–∞:</label>
          <input type="text" id="DEFAULT_STATUS_TEXT" name="DEFAULT_STATUS_TEXT" placeholder="–ü–æ–¥–ø–∏—Å—å">
          <div class="note">–¢–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ —Å—Ç–æ–ª–±—Ü–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</div>
        </div>
        
        <div class="form-group">
          <label for="DEFAULT_FONT_COLOR">–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:</label>
          <div class="color-input-group">
            <input type="color" id="DEFAULT_FONT_COLOR" name="DEFAULT_FONT_COLOR">
            <input type="text" id="DEFAULT_FONT_COLOR_HEX" name="DEFAULT_FONT_COLOR_HEX" placeholder="#999999">
          </div>
        </div>
      </div>
      
      <div class="section" id="colorsSection">
        <div class="section-title">
          üé® –¶–≤–µ—Ç–∞ —Å—Ç–∞—Ç—É—Å–æ–≤
        </div>
        
        <div class="form-group">
          <label for="COLOR_PROCESSING">–¶–≤–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å–∞ (–ø—Ä–æ–≤–µ—Ä–∫–∞):</label>
          <div class="color-input-group">
            <input type="color" id="COLOR_PROCESSING" name="COLOR_PROCESSING">
            <input type="text" id="COLOR_PROCESSING_HEX" name="COLOR_PROCESSING_HEX" placeholder="#FFA500">
          </div>
        </div>
        
        <div class="form-group">
          <label for="COLOR_SUCCESS">–¶–≤–µ—Ç —É—Å–ø–µ—Ö–∞:</label>
          <div class="color-input-group">
            <input type="color" id="COLOR_SUCCESS" name="COLOR_SUCCESS">
            <input type="text" id="COLOR_SUCCESS_HEX" name="COLOR_SUCCESS_HEX" placeholder="#28a745">
          </div>
        </div>
        
        <div class="form-group">
          <label for="COLOR_ERROR">–¶–≤–µ—Ç –æ—à–∏–±–∫–∏:</label>
          <div class="color-input-group">
            <input type="color" id="COLOR_ERROR" name="COLOR_ERROR">
            <input type="text" id="COLOR_ERROR_HEX" name="COLOR_ERROR_HEX" placeholder="#dc3545">
          </div>
        </div>
      </div>
    </div>
    
    <div class="buttons">
      <button id="saveBtn">
        <span id="saveIcon">üíæ</span>
        <span id="saveText">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</span>
      </button>
      <button id="resetBtn">
        <span id="resetIcon">üîÑ</span>
        <span id="resetText">–°–±—Ä–æ—Å–∏—Ç—å</span>
      </button>
    </div>
    
    <div id="statusMessage" class="status-message" style="display: none;"></div>
  </div>

  <script>
    // Global variables
    let pendingAction = null;
    
    // Load configuration when page loads
    document.addEventListener('DOMContentLoaded', function() {
      loadConfiguration();
      setupEventListeners();
    });
    
    function loadConfiguration() {
      google.script.run
        .withSuccessHandler(function(config) {
          // Fill form with current configuration
          document.getElementById('SHEET_NAME').value = config.SHEET_NAME || '';
          document.getElementById('DATA_RANGE_NAME').value = config.DATA_RANGE_NAME || '';
          document.getElementById('CHECKBOX_COLUMNS').value = config.CHECKBOX_COLUMNS || '';
          document.getElementById('STATUS_COLUMNS').value = config.STATUS_COLUMNS || '';
          document.getElementById('NAME_COLUMNS').value = config.NAME_COLUMNS || '';
          document.getElementById('ROW_RANGES').value = config.ROW_RANGES || '';
          document.getElementById('DEFAULT_STATUS_TEXT').value = config.DEFAULT_STATUS_TEXT || '';
          document.getElementById('DEFAULT_FONT_COLOR').value = config.DEFAULT_FONT_COLOR || '#999999';
          document.getElementById('DEFAULT_FONT_COLOR_HEX').value = config.DEFAULT_FONT_COLOR || '#999999';
          document.getElementById('COLOR_PROCESSING').value = config.COLOR_PROCESSING || '#FFA500';
          document.getElementById('COLOR_PROCESSING_HEX').value = config.COLOR_PROCESSING || '#FFA500';
          document.getElementById('COLOR_SUCCESS').value = config.COLOR_SUCCESS || '#28a745';
          document.getElementById('COLOR_SUCCESS_HEX').value = config.COLOR_SUCCESS || '#28a745';
          document.getElementById('COLOR_ERROR').value = config.COLOR_ERROR || '#dc3545';
          document.getElementById('COLOR_ERROR_HEX').value = config.COLOR_ERROR || '#dc3545';
        })
        .withFailureHandler(function(error) {
          showPopup('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é', error.message);
        })
        .loadConfigForPanel();
    }
    
    function setupEventListeners() {
      // Save button
      document.getElementById('saveBtn').addEventListener('click', function() {
        pendingAction = 'save';
        showConfirm(
          '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫',
          '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏?',
          '–¢–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ —Å–∏—Å—Ç–µ–º–µ.',
          performSave
        );
      });
      
      // Reset button
      document.getElementById('resetBtn').addEventListener('click', function() {
        pendingAction = 'reset';
        showConfirm(
          '–°–±—Ä–æ—Å –Ω–∞—Å—Ç—Ä–æ–µ–∫',
          '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏?',
          '–í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—É–¥—É—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∫ –∑–Ω–∞—á–µ–Ω–∏—è–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.',
          performReset
        );
      });
      
      // Color picker sync with hex input
      document.getElementById('DEFAULT_FONT_COLOR').addEventListener('input', function(e) {
        document.getElementById('DEFAULT_FONT_COLOR_HEX').value = e.target.value;
      });
      
      document.getElementById('COLOR_PROCESSING').addEventListener('input', function(e) {
        document.getElementById('COLOR_PROCESSING_HEX').value = e.target.value;
      });
      
      document.getElementById('COLOR_SUCCESS').addEventListener('input', function(e) {
        document.getElementById('COLOR_SUCCESS_HEX').value = e.target.value;
      });
      
      document.getElementById('COLOR_ERROR').addEventListener('input', function(e) {
        document.getElementById('COLOR_ERROR_HEX').value = e.target.value;
      });
      
      // Hex input sync with color picker
      document.getElementById('DEFAULT_FONT_COLOR_HEX').addEventListener('input', function(e) {
        document.getElementById('DEFAULT_FONT_COLOR').value = e.target.value;
      });
      
      document.getElementById('COLOR_PROCESSING_HEX').addEventListener('input', function(e) {
        document.getElementById('COLOR_PROCESSING').value = e.target.value;
      });
      
      document.getElementById('COLOR_SUCCESS_HEX').addEventListener('input', function(e) {
        document.getElementById('COLOR_SUCCESS').value = e.target.value;
      });
      
      document.getElementById('COLOR_ERROR_HEX').addEventListener('input', function(e) {
        document.getElementById('COLOR_ERROR').value = e.target.value;
      });
      
      // Modal buttons
      document.getElementById('modalOkBtn').addEventListener('click', hidePopup);
      document.getElementById('confirmCancelBtn').addEventListener('click', hideConfirm);
      document.getElementById('confirmOkBtn').addEventListener('click', function() {
        if (pendingAction === 'save') {
          performSave();
        } else if (pendingAction === 'reset') {
          performReset();
        }
        hideConfirm();
      });
      
      // Close modals when clicking outside
      document.getElementById('modalOverlay').addEventListener('click', function(e) {
        if (e.target === this) hidePopup();
      });
      
      document.getElementById('confirmModalOverlay').addEventListener('click', function(e) {
        if (e.target === this) hideConfirm();
      });
    }
    
    function performSave() {
      // Show loading overlay
      showLoadingOverlay('üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏', '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ —Å–∏—Å—Ç–µ–º—É...');
      
      // Disable all form inputs and buttons
      setFormState(false);
      
      const config = {
        SHEET_NAME: document.getElementById('SHEET_NAME').value,
        DATA_RANGE_NAME: document.getElementById('DATA_RANGE_NAME').value,
        CHECKBOX_COLUMNS: document.getElementById('CHECKBOX_COLUMNS').value,
        STATUS_COLUMNS: document.getElementById('STATUS_COLUMNS').value,
        NAME_COLUMNS: document.getElementById('NAME_COLUMNS').value,
        ROW_RANGES: document.getElementById('ROW_RANGES').value,
        DEFAULT_STATUS_TEXT: document.getElementById('DEFAULT_STATUS_TEXT').value,
        DEFAULT_FONT_COLOR: document.getElementById('DEFAULT_FONT_COLOR').value,
        COLOR_PROCESSING: document.getElementById('COLOR_PROCESSING').value,
        COLOR_SUCCESS: document.getElementById('COLOR_SUCCESS').value,
        COLOR_ERROR: document.getElementById('COLOR_ERROR').value
      };
      
      google.script.run
        .withSuccessHandler(function(response) {
          // Hide loading overlay
          hideLoadingOverlay();
          
          // Re-enable form
          setFormState(true);
          
          // Show success message
          showPopup('success', '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!', '–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞', response.message);
          
          // Auto-hide after 5 seconds
          setTimeout(() => {
            if (document.getElementById('modalOverlay').classList.contains('active')) {
              hidePopup();
            }
          }, 5000);
        })
        .withFailureHandler(function(error) {
          // Hide loading overlay
          hideLoadingOverlay();
          
          // Re-enable form even on error
          setFormState(true);
          
          // Show error message
          showPopup('error', '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é', error.message);
        })
        .saveConfig(config);
    }
    
    function performReset() {
      // Show loading overlay
      showLoadingOverlay('üîÑ –°–±—Ä–æ—Å –Ω–∞—Å—Ç—Ä–æ–µ–∫', '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é...');
      
      // Disable all form inputs and buttons
      setFormState(false);
      
      google.script.run
        .withSuccessHandler(function(response) {
          // Hide loading overlay
          hideLoadingOverlay();
          
          // Re-enable form
          setFormState(true);
          
          // Show success message
          showPopup('success', '–°–±—Ä–æ—à–µ–Ω–æ!', '–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–±—Ä–æ—à–µ–Ω–∞', response.message);
          
          // Reload the form with default values
          loadConfiguration();
          
          // Auto-hide after 5 seconds
          setTimeout(() => {
            if (document.getElementById('modalOverlay').classList.contains('active')) {
              hidePopup();
            }
          }, 5000);
        })
        .withFailureHandler(function(error) {
          // Hide loading overlay
          hideLoadingOverlay();
          
          // Re-enable form even on error
          setFormState(true);
          
          // Show error message
          showPopup('error', '–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–±—Ä–æ—Å–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é', error.message);
        })
        .resetConfig();
    }
    
    function showPopup(type, title, subtitle, message) {
      const modal = document.getElementById('messageModal');
      const overlay = document.getElementById('modalOverlay');
      const icon = document.getElementById('modalIcon');
      const modalTitle = document.getElementById('modalTitle');
      const modalSubtitle = document.getElementById('modalSubtitle');
      const modalMessage = document.getElementById('modalMessage');
      
      // Set content based on type
      modal.className = 'modal ' + type;
      
      if (type === 'success') {
        icon.textContent = '‚úÖ';
      } else if (type === 'error') {
        icon.textContent = '‚ùå';
      } else if (type === 'warning') {
        icon.textContent = '‚ö†Ô∏è';
      } else {
        icon.textContent = '‚ÑπÔ∏è';
      }
      
      modalTitle.textContent = title;
      modalSubtitle.textContent = subtitle;
      modalMessage.textContent = message;
      
      // Show modal
      overlay.classList.add('active');
    }
    
    function hidePopup() {
      document.getElementById('modalOverlay').classList.remove('active');
    }
    
    function showConfirm(title, subtitle, message, callback) {
      const overlay = document.getElementById('confirmModalOverlay');
      const confirmTitle = document.getElementById('confirmModalTitle');
      const confirmSubtitle = document.getElementById('confirmModalSubtitle');
      const confirmMessage = document.getElementById('confirmModalMessage');
      const confirmOkBtn = document.getElementById('confirmOkBtn');
      
      confirmTitle.textContent = title;
      confirmSubtitle.textContent = subtitle;
      confirmMessage.textContent = message;
      
      // Store the callback
      confirmOkBtn.onclick = callback;
      
      // Show modal
      overlay.classList.add('active');
    }
    
    function hideConfirm() {
      document.getElementById('confirmModalOverlay').classList.remove('active');
    }
    
    function showLoadingOverlay(title, message) {
      const overlay = document.getElementById('loadingOverlay');
      const titleEl = document.getElementById('loadingTitle');
      const messageEl = document.getElementById('loadingMessage');
      
      titleEl.textContent = title;
      messageEl.textContent = message;
      overlay.classList.add('active');
      
      // Simulate progress animation
      const progressBar = document.getElementById('progressBar');
      const progressContainer = document.getElementById('progressContainer');
      progressContainer.style.display = 'block';
      progressBar.style.width = '0%';
      
      // Animate progress bar
      setTimeout(() => { progressBar.style.width = '30%'; }, 100);
      setTimeout(() => { progressBar.style.width = '60%'; }, 300);
      setTimeout(() => { progressBar.style.width = '90%'; }, 600);
    }
    
    function hideLoadingOverlay() {
      const overlay = document.getElementById('loadingOverlay');
      const progressBar = document.getElementById('progressBar');
      const progressContainer = document.getElementById('progressContainer');
      
      // Complete progress bar
      progressBar.style.width = '100%';
      
      // Hide overlay after a short delay
      setTimeout(() => {
        overlay.classList.remove('active');
        progressContainer.style.display = 'none';
      }, 300);
    }
    
    function setFormState(enabled) {
      const saveBtn = document.getElementById('saveBtn');
      const resetBtn = document.getElementById('resetBtn');
      const saveText = document.getElementById('saveText');
      const resetText = document.getElementById('resetText');
      const saveIcon = document.getElementById('saveIcon');
      const resetIcon = document.getElementById('resetIcon');
      const sections = document.querySelectorAll('.section');
      const inputs = document.querySelectorAll('input');
      
      // Update buttons
      saveBtn.disabled = !enabled;
      resetBtn.disabled = !enabled;
      
      if (!enabled) {
        // Show loading state on buttons
        saveText.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
        resetText.textContent = '–°–±—Ä–æ—Å...';
        saveIcon.innerHTML = '<div class="spinner"></div>';
        resetIcon.innerHTML = '<div class="spinner"></div>';
        
        // Disable all sections visually
        sections.forEach(section => {
          section.classList.add('disabled');
        });
        
        // Disable all inputs
        inputs.forEach(input => {
          input.disabled = true;
        });
      } else {
        // Restore button text
        saveText.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
        resetText.textContent = '–°–±—Ä–æ—Å–∏—Ç—å';
        saveIcon.textContent = 'üíæ';
        resetIcon.textContent = 'üîÑ';
        
        // Enable all sections
        sections.forEach(section => {
          section.classList.remove('disabled');
        });
        
        // Enable all inputs
        inputs.forEach(input => {
          input.disabled = false;
        });
      }
    }
  </script>
</body>
</html>